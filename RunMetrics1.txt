package com.example.ingest.ops;

import io.micrometer.core.instrument.*;
import org.springframework.stereotype.Component;

import java.util.UUID;
import java.util.concurrent.ConcurrentHashMap;

@Component
public class RunMetrics {

  private final MeterRegistry registry;
  private final ConcurrentHashMap<UUID, Counters> runs = new ConcurrentHashMap<>();

  public RunMetrics(MeterRegistry registry) {
    this.registry = registry;
  }

  public void start(UUID runId, String upd, int total) {
    runs.put(runId, new Counters(
      Counter.builder("ingest.run.success").tag("run", runId.toString()).register(registry),
      Counter.builder("ingest.run.failed").tag("run", runId.toString()).register(registry),
      Gauge.builder("ingest.run.total", total, Number::doubleValue)
        .tag("run", runId.toString()).register(registry)
    ));
  }

  public void success(UUID runId) {
    var c = runs.get(runId);
    if (c != null) c.success.increment();
  }

  public void failed(UUID runId) {
    var c = runs.get(runId);
    if (c != null) c.failed.increment();
  }

  public void finish(UUID runId) {
    runs.remove(runId);
  }

  private record Counters(Counter success, Counter failed, Gauge total) {}
}
