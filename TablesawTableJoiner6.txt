import tech.tablesaw.api.*;
import java.util.*;

public class TablesawTableJoiner {

    public static Table joinAllIntoOneTable(
            Map<String, Table> tables,
            Map<String, List<JoinSpec>> joinSpecs,
            String rootTable
    ) {

        Table base = tables.get(rootTable);
        if (base == null) {
            throw new IllegalArgumentException(
                    "Root table not found: " + rootTable +
                    ", available=" + tables.keySet()
            );
        }

        Table result = cleanup(base);

        for (Map.Entry<String, List<JoinSpec>> e : joinSpecs.entrySet()) {

            Table child = tables.get(e.getKey());
            if (child == null) continue;

            child = cleanup(child);

            for (JoinSpec spec : e.getValue()) {

                if (spec.cardinality == JoinSpec.Cardinality.ONE_TO_MANY) continue;

                if (!result.columnNames().contains(spec.rightKey)) continue;
                if (!child.columnNames().contains(spec.leftKey)) continue;

                result =
                        result.joinOn(spec.rightKey)
                              .leftOuter(child, spec.leftKey);
            }
        }
        return result;
    }

    private static Table cleanup(Table t) {
        if (t == null) return null;
        if (t.columnNames().contains("sourcePath")) {
            t = t.removeColumns("sourcePath");
        }
        return t.copy();
    }
}
