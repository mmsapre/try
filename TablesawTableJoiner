import tech.tablesaw.api.*;

import java.util.*;

public class TablesawTableJoiner {

    public static Table joinAllParentIdLinkedTables(Map<String, Table> tables) {
        Map<String, Table> workingTables = new HashMap<>();

        // 1. Copy tables, remove sourcePath if present
        for (Map.Entry<String, Table> entry : tables.entrySet()) {
            Table t = entry.getValue();
            if (t.columnNames().contains("sourcePath")) {
                t = t.removeColumns("sourcePath");
            }
            workingTables.put(entry.getKey(), t.copy());
        }

        // 2. Perform join for all tables that have parent_id
        for (Map.Entry<String, Table> childEntry : workingTables.entrySet()) {
            String childKey = childEntry.getKey();
            Table child = childEntry.getValue();

            if (!child.columnNames().contains("parent_id")) continue;

            // Find valid parent (exclude self)
            String parentKey = findParentTableKey(childKey, workingTables);
            if (parentKey == null) continue;

            Table parent = workingTables.get(parentKey);
            if (parent == null || !parent.columnNames().contains("_row_id")) continue;

            // Remove overlapping columns except parent_id
            Set<String> parentCols = new HashSet<>(parent.columnNames());
            List<String> toDrop = new ArrayList<>();
            for (String col : child.columnNames()) {
                if (!col.equals("parent_id") && parentCols.contains(col)) {
                    toDrop.add(col);
                }
            }

            if (!toDrop.isEmpty()) {
                child = child.removeColumns(toDrop.toArray(new String[0]));
            }

            Table joined = parent.joinOn("_row_id").inner(child, "parent_id");
            workingTables.put(childKey, joined);
        }

        // 3. Merge all joined tables with same schema
        return mergeAll(workingTables.values());
    }

    private static String findParentTableKey(String childKey, Map<String, Table> tables) {
        for (Map.Entry<String, Table> entry : tables.entrySet()) {
            String key = entry.getKey();
            if (key.equals(childKey)) continue;

            Table candidate = entry.getValue();
            if (candidate.columnNames().contains("_row_id")) {
                return key;
            }
        }
        return null;
    }

    private static Table mergeAll(Collection<Table> tables) {
        Iterator<Table> it = tables.iterator();
        if (!it.hasNext()) return Table.create("empty");

        Table merged = it.next();
        while (it.hasNext()) {
            Table next = it.next();
            if (next.structure().equals(merged.structure())) {
                merged = merged.append(next);
            }
        }
        return merged;
    }
}
