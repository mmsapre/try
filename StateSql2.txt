public final class StateSql {

  public static final String INSERT_SEARCH_ID = """
    INSERT INTO api_item_state(load_rowid, ext_id, status, attempts)
    VALUES (:lr, :id, 'NEW', 0)
    ON CONFLICT (load_rowid, ext_id) DO NOTHING
  """;

  public static final String CLAIM = """
    UPDATE api_item_state
       SET status='IN_PROGRESS',
           attempts = attempts + 1,
           updated_at = now()
     WHERE load_rowid=:lr
       AND ext_id=:id
       AND attempts < :max
    RETURNING true
  """;

  public static final String SUCCESS = """
    UPDATE api_item_state
       SET status='SUCCESS',
           updated_at = now()
     WHERE load_rowid=:lr AND ext_id=:id
  """;

  public static final String FAILED = """
    UPDATE api_item_state
       SET status='FAILED',
           last_error=:err,
           next_retry_at=now()+:cooldown,
           updated_at = now()
     WHERE load_rowid=:lr AND ext_id=:id
  """;
}
