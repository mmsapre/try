import tech.tablesaw.api.*;

import java.util.*;

public class TableJoinUtil {

    public static Table joinAllParentIdLinkedTables(Map<String, Table> tables) {
        Map<String, Table> tableMap = new HashMap<>(tables);
        Map<String, Table> joinedMap = new HashMap<>();

        // Deep copy to avoid mutation
        for (Map.Entry<String, Table> entry : tableMap.entrySet()) {
            joinedMap.put(entry.getKey(), entry.getValue().copy());
        }

        for (Map.Entry<String, Table> childEntry : tableMap.entrySet()) {
            Table child = childEntry.getValue();
            if (!child.columnNames().contains("parent_id")) continue;

            String parentTableKey = findParentTableKey(child, joinedMap);
            if (parentTableKey == null) continue;

            Table parent = joinedMap.get(parentTableKey);
            if (parent == null || !parent.columnNames().contains("_row_id")) continue;

            // Drop overlapping columns except parent_id
            Set<String> parentCols = new HashSet<>(parent.columnNames());
            List<String> toDrop = new ArrayList<>();
            for (String col : child.columnNames()) {
                if (!col.equals("parent_id") && parentCols.contains(col)) {
                    toDrop.add(col);
                }
            }

            if (!toDrop.isEmpty()) {
                child = child.removeColumns(toDrop.toArray(new String[0]));
            }

            Table joined = parent.joinOn("_row_id").inner(child, "parent_id");
            joinedMap.put(childEntry.getKey(), joined);
        }

        return mergeAll(joinedMap.values());
    }

    private static String findParentTableKey(Table child, Map<String, Table> candidates) {
        for (Map.Entry<String, Table> entry : candidates.entrySet()) {
            Table t = entry.getValue();
            if (t.columnNames().contains("_row_id")) {
                return entry.getKey();
            }
        }
        return null;
    }

    private static Table mergeAll(Collection<Table> tables) {
        Iterator<Table> it = tables.iterator();
        if (!it.hasNext()) return Table.create("empty");

        Table merged = it.next();
        while (it.hasNext()) {
            Table t = it.next();
            if (!t.structure().equals(merged.structure())) continue;
            merged = merged.append(t);
        }
        return merged;
    }
}
