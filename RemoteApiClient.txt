package com.example.ingest.api;

import com.example.ingest.config.ApiProps;
import com.example.ingest.model.Dtos.ItemDetails;
import com.example.ingest.model.Dtos.PageResponse;
import org.springframework.http.HttpStatusCode;
import org.springframework.stereotype.Component;
import org.springframework.web.reactive.function.client.WebClient;
import org.springframework.web.reactive.function.client.WebClientResponseException;
import reactor.core.publisher.Mono;
import reactor.util.retry.Retry;

import java.time.Duration;
import java.util.Map;

@Component
public class RemoteApiClient {

  private final WebClient webClient;
  private final ApiProps props;

  public RemoteApiClient(WebClient webClient, ApiProps props) {
    this.webClient = webClient;
    this.props = props;
  }

  public Mono<PageResponse> fetchPage(int offset) {
    return webClient.get()
      .uri(uriBuilder -> uriBuilder
        .path(props.getListPath())
        .queryParam("limit", props.getPageSize())
        .queryParam("offset", offset)
        .build())
      .retrieve()
      .bodyToMono(PageResponse.class)
      .timeout(Duration.ofSeconds(20))
      .retryWhen(retrySpec());
  }

  @SuppressWarnings("unchecked")
  public Mono<ItemDetails> fetchDetails(String id) {
    return webClient.get()
      .uri(props.getDetailPath(), id)
      .retrieve()
      .bodyToMono(Map.class)
      .map(m -> new ItemDetails(id, (Map<String, Object>) m))
      .timeout(Duration.ofSeconds(20))
      .retryWhen(retrySpec());
  }

  private Retry retrySpec() {
    return Retry.backoff(props.getRetry().getMaxAttempts(), Duration.ofMillis(props.getRetry().getFirstBackoffMs()))
      .maxBackoff(Duration.ofMillis(props.getRetry().getMaxBackoffMs()))
      .jitter(0.2)
      .filter(this::isRetryable);
  }

  private boolean isRetryable(Throwable t) {
    if (t instanceof WebClientResponseException w) {
      HttpStatusCode sc = w.getStatusCode();
      return sc.is5xxServerError() || sc.value() == 429;
    }
    return true; // timeouts / IO
  }
}
