import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import tech.tablesaw.api.*;

import java.io.IOException;
import java.time.LocalDate;
import java.util.*;

public class JsonToTablesawFlattener {

    private final ObjectMapper mapper = new ObjectMapper();
    private final Map<String, List<Map<String, Object>>> rawTables = new LinkedHashMap<>();
    private int idCounter = 1;

    public Map<String, Table> flattenJson(String json) throws IOException {
        JsonNode root = mapper.readTree(json);

        if (root == null || root.isNull()) {
            return Map.of();
        }

        if (root.isArray()) {
            for (JsonNode node : root) {
                flatten("root", node, null);
            }
        } else {
            flatten("root", root, null);
        }

        Map<String, Table> tables = new LinkedHashMap<>();
        for (Map.Entry<String, List<Map<String, Object>>> e : rawTables.entrySet()) {
            tables.put(e.getKey(), toTable(e.getKey(), e.getValue()));
        }
        return tables;
    }

    private void flatten(String table, JsonNode node, String parentId) {

        if (node == null || node.isNull()) return;

        if (node.isArray()) {
            for (JsonNode item : node) {
                flatten(table, item, parentId);
            }
            return;
        }

        if (!node.isObject()) return;

        Map<String, Object> row = new LinkedHashMap<>();
        String currentId = "r" + (idCounter++);

        row.put("_row_id", currentId);
        if (parentId != null) {
            row.put("parent_id", parentId);
        }

        Iterator<Map.Entry<String, JsonNode>> fields = node.fields();
        while (fields.hasNext()) {
            Map.Entry<String, JsonNode> f = fields.next();
            String key = f.getKey();
            JsonNode value = f.getValue();

            if (value == null || value.isNull()) {
                row.put(key, null);
            } else if (value.isValueNode()) {
                row.put(key, value.asText());
            } else if (value.isObject()) {
                flatten(table + "_" + key, value, currentId);
            } else if (value.isArray()) {
                for (JsonNode item : value) {
                    if (item.isValueNode()) {
                        Map<String, Object> arrayRow = new LinkedHashMap<>();
                        arrayRow.put("_row_id", "r" + (idCounter++));
                        arrayRow.put("parent_id", currentId);
                        arrayRow.put("value", item.asText());
                        arrayRow.put("sourcePath", table + "." + key);
                        add(table + "_" + key, arrayRow);
                    } else {
                        flatten(table + "_" + key, item, currentId);
                    }
                }
            }
        }

        row.put("sourcePath", table);
        add(table, row);
    }

    private void add(String table, Map<String, Object> row) {
        rawTables.computeIfAbsent(table, t -> new ArrayList<>()).add(row);
    }

    private Table toTable(String name, List<Map<String, Object>> rows) {
        if (rows == null || rows.isEmpty()) {
            return Table.create(name);
        }

        Map<String, List<Object>> cols = new LinkedHashMap<>();
        rows.forEach(r ->
            r.keySet().forEach(k ->
                cols.computeIfAbsent(k, x -> new ArrayList<>()))
        );

        rows.forEach(r ->
            cols.forEach((k, v) ->
                v.add(r.getOrDefault(k, null)))
        );

        Table table = Table.create(name);
        cols.forEach((k, v) -> table.addColumns(inferColumn(k, v)));
        return table;
    }

    private Column<?> inferColumn(String name, List<Object> values) {

        List<String> s = new ArrayList<>();
        List<Integer> i = new ArrayList<>();
        List<Double> d = new ArrayList<>();
        List<Boolean> b = new ArrayList<>();
        List<LocalDate> dt = new ArrayList<>();

        boolean ai = true, ad = true, ab = true, adt = true;

        for (Object o : values) {
            String v = o == null ? "" : o.toString().trim();
            s.add(v);

            try { i.add(Integer.parseInt(v)); } catch (Exception e) { ai = false; i.add(null); }
            try { d.add(Double.parseDouble(v)); } catch (Exception e) { ad = false; d.add(null); }
            try { b.add(Boolean.parseBoolean(v)); } catch (Exception e) { ab = false; b.add(null); }

            try {
                dt.add(v.length() >= 10 ? LocalDate.parse(v.substring(0, 10)) : null);
            } catch (Exception e) {
                adt = false;
                dt.add(null);
            }
        }

        if (ai) return IntColumn.create(name, i);
        if (ad) return DoubleColumn.create(name, d);
        if (ab) return BooleanColumn.create(name, b);
        if (adt) return DateColumn.create(name, dt);
        return StringColumn.create(name, s);
    }
}
