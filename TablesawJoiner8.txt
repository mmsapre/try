import tech.tablesaw.api.Table;
import tech.tablesaw.api.StringColumn;

import java.util.*;

public class TablesawJoiner {

    public static Table joinAll(Map<String, Table> tables) {

        // 1️⃣ Find root table safely
        String rootKey = tables.entrySet().stream()
            .filter(e -> isRootTable(e.getValue()))
            .map(Map.Entry::getKey)
            .findFirst()
            .orElseThrow(() ->
                new IllegalStateException("No root table found")
            );

        Table result = tables.get(rootKey);

        Set<String> joined = new HashSet<>();
        joined.add(rootKey);

        // 2️⃣ Iteratively join children
        boolean progress;
        do {
            progress = false;

            for (Map.Entry<String, Table> entry : tables.entrySet()) {
                String childKey = entry.getKey();
                if (joined.contains(childKey)) continue;

                Table child = entry.getValue();
                if (!child.columnNames().contains("parent_id")) continue;

                // universal join rule
                result = result.joinOn("_row_id")
                               .leftOuter(child, "parent_id");

                joined.add(childKey);
                progress = true;
            }
        } while (progress);

        return result;
    }

    // ✅ Tablesaw-safe root detection
    private static boolean isRootTable(Table table) {

        if (!table.columnNames().contains("parent_id")) {
            return true;
        }

        StringColumn parentCol = table.stringColumn("parent_id");

        // ALL rows missing → root
        return parentCol.countMissing() == parentCol.size();
    }
}
