import tech.tablesaw.api.Table;
import tech.tablesaw.api.StringColumn;

import java.util.*;

public class TablesawJoiner {

    public static Table joinAll(Map<String, Table> tables) {

        // 1️⃣ Find root table
        String rootKey = tables.entrySet().stream()
            .filter(e -> isRootTable(e.getValue()))
            .map(Map.Entry::getKey)
            .findFirst()
            .orElseThrow(() ->
                new IllegalStateException("No root table found")
            );

        Table result = tables.get(rootKey).copy();
        Set<String> joined = new HashSet<>();
        joined.add(rootKey);

        boolean progress;

        do {
            progress = false;

            for (Map.Entry<String, Table> entry : tables.entrySet()) {
                String childKey = entry.getKey();
                if (joined.contains(childKey)) continue;

                Table child = entry.getValue();

                // must have parent_id to join
                if (!child.columnNames().contains("parent_id")) continue;

                // 2️⃣ Join FIRST (parent._row_id = child.parent_id)
                Table joinedResult =
                        result.joinOn("_row_id")
                              .leftOuter(child, "parent_id");

                // 3️⃣ Remove duplicate lineage columns AFTER join
                if (joinedResult.columnNames().contains("parent_id")) {
                    joinedResult.removeColumns("parent_id");
                }
                if (joinedResult.columnNames().contains("_row_id_1")) {
                    joinedResult.removeColumns("_row_id_1");
                }

                result = joinedResult;
                joined.add(childKey);
                progress = true;
            }

        } while (progress);

        return result;
    }

    // ✅ Tablesaw-safe root detection
    private static boolean isRootTable(Table table) {
        if (!table.columnNames().contains("parent_id")) {
            return true;
        }
        StringColumn parentCol = table.stringColumn("parent_id");
        return parentCol.countMissing() == parentCol.size();
    }
}
