import tech.tablesaw.api.Table;
import tech.tablesaw.api.StringColumn;

import java.util.*;

public class TablesawJoiner {

    public static Table joinAll(Map<String, Table> tables) {

        // 1ï¸âƒ£ Find root table
        String rootKey = tables.entrySet().stream()
            .filter(e -> isRootTable(e.getValue()))
            .map(Map.Entry::getKey)
            .findFirst()
            .orElseThrow(() ->
                new IllegalStateException("No root table found")
            );

        Table result = tables.get(rootKey).copy();

        // tables already joined into result
        Set<String> joined = new HashSet<>();
        joined.add(rootKey);

        boolean progress;

        do {
            progress = false;

            for (Map.Entry<String, Table> entry : tables.entrySet()) {
                String childKey = entry.getKey();
                Table child = entry.getValue();

                // ðŸš« already joined
                if (joined.contains(childKey)) continue;

                // ðŸš« cannot join without parent_id
                if (!child.columnNames().contains("parent_id")) continue;

                // ðŸš« parent_id must have at least one value
                StringColumn parentCol = child.stringColumn("parent_id");
                if (parentCol.countMissing() == parentCol.size()) continue;

                // âœ… JOIN (parent._row_id = child.parent_id)
                Table joinedResult =
                        result.joinOn("_row_id")
                              .leftOuter(child, "parent_id");

                // ðŸ§¹ cleanup AFTER join
                if (joinedResult.columnNames().contains("parent_id")) {
                    joinedResult.removeColumns("parent_id");
                }
                if (joinedResult.columnNames().contains("_row_id_1")) {
                    joinedResult.removeColumns("_row_id_1");
                }

                result = joinedResult;
                joined.add(childKey);
                progress = true;
            }

        } while (progress);

        return result;
    }

    // âœ… Root = no parent_id OR all parent_id null
    private static boolean isRootTable(Table table) {
        if (!table.columnNames().contains("parent_id")) {
            return true;
        }
        StringColumn parentCol = table.stringColumn("parent_id");
        return parentCol.countMissing() == parentCol.size();
    }
}
