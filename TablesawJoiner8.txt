import tech.tablesaw.api.Table;
import java.util.*;

public class TablesawJoiner {

    public static Table joinAll(Map<String, Table> tables) {

        String rootKey = tables.entrySet().stream()
            .filter(e -> isRootTable(e.getValue()))
            .map(Map.Entry::getKey)
            .findFirst()
            .orElseThrow(() ->
                new IllegalStateException("No root table found")
            );

        Table result = tables.get(rootKey).copy();
        Set<String> joined = new HashSet<>();
        joined.add(rootKey);

        boolean progress;
        do {
            progress = false;

            for (Map.Entry<String, Table> entry : tables.entrySet()) {
                String childKey = entry.getKey();
                if (joined.contains(childKey)) continue;

                Table child = entry.getValue();
                if (!child.columnNames().contains("parent_id")) continue;

                // ðŸ”¥ IMPORTANT: remove duplicate lineage columns
                Table childForJoin = child.copy();

                childForJoin.removeColumns("_row_id");
                childForJoin.removeColumns("parent_id");

                // universal join rule
                result = result.joinOn("_row_id")
                               .leftOuter(childForJoin, "parent_id");

                joined.add(childKey);
                progress = true;
            }
        } while (progress);

        return result;
    }

    private static boolean isRootTable(Table table) {
        if (!table.columnNames().contains("parent_id")) return true;
        return table.stringColumn("parent_id").countMissing()
                == table.rowCount();
    }
}
